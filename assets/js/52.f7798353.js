(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{413:function(s,a,t){"use strict";t.r(a);var n=t(16),l=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("发布—订阅模式定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知。在 "),t("code",[s._v("JavaScript")]),s._v(" 开发中，我们一般用事件模型来替代传统的发布—订阅模式。")])]),s._v(" "),t("h2",{attrs:{id:"发布-订阅模式的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发布-订阅模式的作用"}},[s._v("#")]),s._v(" 发布-订阅模式的作用")]),s._v(" "),t("ol",[t("li",[s._v("发布-订阅模式可以广泛应用于一步编程中，这是一种替代传递回调函数的方案。在异步编程中使用发布-订阅模式，我们就无需过多关注对象在异步运行期间的内部状态，而只需要订阅感兴趣的事件发生点。")]),s._v(" "),t("li",[s._v("发布-订阅模式可以取代对象之间硬编码的通知机制，一个对象不用再显试地调用另外一个对象的某个接口。发布-订阅可以让两个对象松耦合地联系在一起，虽然不太清楚彼此的细节，但这不影响它们之间相互通信。")])]),s._v(" "),t("h2",{attrs:{id:"dom事件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dom事件"}},[s._v("#")]),s._v(" DOM事件")]),s._v(" "),t("p",[s._v("我们使用的DOM事件其实就是JavaScript中一个很典型的发布-订阅模式")]),s._v(" "),t("div",{staticClass:"language-JavaScript extra-class"},[t("pre",[t("code",{staticClass:"language-JavaScript"},[t("span",{staticClass:"hljs-built_in"},[s._v("document")]),s._v(".body.addEventListener("),t("span",{staticClass:"hljs-string"},[s._v("'click'")]),s._v(", "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n\talert("),t("span",{staticClass:"hljs-number"},[s._v("1")]),s._v(")\n}, "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(")\n\n"),t("span",{staticClass:"hljs-built_in"},[s._v("document")]),s._v(".body.click()\n")])])]),t("p",[s._v("订阅document.body上的click事件，当body被点击时，body节点便会向订阅者发布这个消息。")]),s._v(" "),t("h2",{attrs:{id:"自定义事件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义事件"}},[s._v("#")]),s._v(" 自定义事件")]),s._v(" "),t("p",[s._v("实现发布-订阅模式的步骤")]),s._v(" "),t("ol",[t("li",[s._v("首先要指定好谁充当发布者")]),s._v(" "),t("li",[s._v("给发布者添加一个缓存列表，用于存放回调函数以便通知订阅者")]),s._v(" "),t("li",[s._v("发布消息的时候，发布者会遍历这个缓存列表，依次触发里面存放的订阅者回调函数")])]),s._v(" "),t("p",[s._v("案例：买房者们向售楼部订阅楼盘信息，把电话号码留在售楼处。新楼盘推出时，售楼MM翻开花名册，依次发短信通知买房者们")]),s._v(" "),t("div",{staticClass:"language-JavaScript extra-class"},[t("pre",[t("code",{staticClass:"language-JavaScript"},[t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" salesOffices = {} "),t("span",{staticClass:"hljs-comment"},[s._v("// 定义售楼处")]),s._v("\n\nsalesOffices.clientList = {} "),t("span",{staticClass:"hljs-comment"},[s._v("// 缓存列表，存放订阅者的回调函数")]),s._v("\n\nsalesOffices.listen = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("key,fn")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!"),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientList[key]) {\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientList[key] = []\n  }\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientList[key].push(fn);\n}\n\nsalesOffices.triggle = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" key = "),t("span",{staticClass:"hljs-built_in"},[s._v("Array")]),s._v(".prototype.shift.call("),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v(");\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fns = "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientList[key];\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fns||fns.length === "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(") {\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n  }\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("for")]),s._v("("),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" i="),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(", fn; fn = fns[i++];){\n    fn.apply("),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(","),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v(");\n  }\n}\n\nsalesOffices.listen("),t("span",{staticClass:"hljs-string"},[s._v('"88squareMeter"')]),s._v(", "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"小明，有一个88平的房子，价格:"')]),s._v(" + price);\n})\n\nsalesOffices.listen("),t("span",{staticClass:"hljs-string"},[s._v('"100squareMeter"')]),s._v(","),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"小华，有一个100平的房子，价格"')]),s._v(" + price);\n})\n\nsalesOffices.listen("),t("span",{staticClass:"hljs-string"},[s._v('"100squareMeter"')]),s._v(","),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"小明，有个100平的房子，价格:"')]),s._v(" + price);\n})\n\nsalesOffices.triggle("),t("span",{staticClass:"hljs-string"},[s._v('"88squareMeter"')]),s._v(", "),t("span",{staticClass:"hljs-number"},[s._v("2000000")]),s._v(");\nsalesOffices.triggle("),t("span",{staticClass:"hljs-string"},[s._v('"100squareMeter"')]),s._v(", "),t("span",{staticClass:"hljs-number"},[s._v("3000000")]),s._v(");\nsalesOffices.triggle("),t("span",{staticClass:"hljs-string"},[s._v('"200squareMeter"')]),s._v(", "),t("span",{staticClass:"hljs-number"},[s._v("7000000")]),s._v(");\n")])])]),t("p",[s._v("上面的代码实现了基本的发布-订阅功能，但是使用了全局变量，代码的复用性也比较差")]),s._v(" "),t("h2",{attrs:{id:"发布-订阅模式的通用实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发布-订阅模式的通用实现"}},[s._v("#")]),s._v(" 发布-订阅模式的通用实现")]),s._v(" "),t("div",{staticClass:"language-JavaScript extra-class"},[t("pre",[t("code",{staticClass:"language-JavaScript"},[t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" event = {\n  "),t("span",{staticClass:"hljs-attr"},[s._v("init")]),s._v(": "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist = {};\n\t},\n\t\n  "),t("span",{staticClass:"hljs-attr"},[s._v("listen")]),s._v(": "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("key, fn")]),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!"),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist) {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist = {};\n    }\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!"),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist[key]) {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist[key] = [];\n    }\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist[key].push(fn);\n\t},\n\t\n  "),t("span",{staticClass:"hljs-attr"},[s._v("trigger")]),s._v(": "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" key = "),t("span",{staticClass:"hljs-built_in"},[s._v("Array")]),s._v(".prototype.shift.call("),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v(");\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fns = "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist[key];\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fns || fns.length === "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(") {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n    }\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("for")]),s._v(" ("),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" i = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(", fn; fn = fns[i++];) {\n      fn.apply("),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(", "),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v(");\n    }\n\t},\n\t\n  "),t("span",{staticClass:"hljs-attr"},[s._v("remove")]),s._v(": "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("key, fn")]),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fns = "),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".clientlist[key];\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fns) {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n    }\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fn) {\n      fns.length = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(";\n    } "),t("span",{staticClass:"hljs-keyword"},[s._v("else")]),s._v(" {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("for")]),s._v(" ("),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" i = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v("; i < fns.length; i++) {\n        "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (fn === fns[i]) {\n          fns.splice(i, "),t("span",{staticClass:"hljs-number"},[s._v("1")]),s._v(");\n        }\n      }\n    }\n  }\n}\n\n"),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" salesOffice = {};\nevent.init.call(salesOffice);\n\n"),t("span",{staticClass:"hljs-comment"},[s._v("//小明订阅88平米")]),s._v("\n"),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fn1 = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"你好小明，你订阅的88平米房子，价格:"')]),s._v(" + price);\n}\n\n"),t("span",{staticClass:"hljs-comment"},[s._v("//小红订阅88平米")]),s._v("\n"),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fn2 = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"你好小红，你订阅的88平米房子，价格:"')]),s._v(" + price);\n}\n\n"),t("span",{staticClass:"hljs-comment"},[s._v("//小红订阅100平米")]),s._v("\n"),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fn3 = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("price")]),s._v(") ")]),s._v("{\n  "),t("span",{staticClass:"hljs-built_in"},[s._v("console")]),s._v(".log("),t("span",{staticClass:"hljs-string"},[s._v('"你好小红，你订阅的100平米房子，价格:"')]),s._v(" + price);\n}\n\nevent.listen.call(salesOffice, "),t("span",{staticClass:"hljs-string"},[s._v('"m88"')]),s._v(", fn1);\nevent.listen.call(salesOffice, "),t("span",{staticClass:"hljs-string"},[s._v('"m88"')]),s._v(", fn2);\nevent.listen.call(salesOffice, "),t("span",{staticClass:"hljs-string"},[s._v('"m100"')]),s._v(", fn3);\nevent.remove.call(salesOffice, "),t("span",{staticClass:"hljs-string"},[s._v('"m88"')]),s._v(", fn2);\nevent.trigger.call(salesOffice, "),t("span",{staticClass:"hljs-string"},[s._v('"m88"')]),s._v(", "),t("span",{staticClass:"hljs-number"},[s._v("1000000")]),s._v(");\n")])])]),t("p",[s._v("上面的代码还存在两个问题")]),s._v(" "),t("ul",[t("li",[s._v("我们给每个发布者对象都添加了listen和trigger方法，以及一个缓存列表clientList，这其实是一种资源浪费")]),s._v(" "),t("li",[s._v("买房者跟售楼处对象还存在着一定的耦合性，买房者至少要知道售楼处对象的名字是salesOffice，才能顺利的订阅到事件。")])]),s._v(" "),t("h2",{attrs:{id:"全局的发布-订阅对象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#全局的发布-订阅对象"}},[s._v("#")]),s._v(" 全局的发布-订阅对象")]),s._v(" "),t("div",{staticClass:"language-JavaScript extra-class"},[t("pre",[t("code",{staticClass:"language-JavaScript"},[t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" Event = ("),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n\t"),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" clientList = {}, listen, trigger, remove;\n\t\n  listen = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("key, fn")]),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!clientList[key]) {\n      clientList[key]=[];\n    }\n  \tclientList[key].push(fn);\n\t}\n\t\n  trigger = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" key = "),t("span",{staticClass:"hljs-built_in"},[s._v("Array")]),s._v(".prototype.shift.call("),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v("),\n\t\t\t\tfns = clientList[key];\n\t\t\t\t\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fns || fns.length === "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(") {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n    }\n\t\t\n\t\t"),t("span",{staticClass:"hljs-keyword"},[s._v("for")]),s._v(" ("),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" i = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(", fn; fn = fns[i++];) {\n      fn.apply("),t("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(", "),t("span",{staticClass:"hljs-built_in"},[s._v("arguments")]),s._v(");\n    }\n\t}\n\t\n  remove = "),t("span",{staticClass:"hljs-function"},[t("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" ("),t("span",{staticClass:"hljs-params"},[s._v("key, fn")]),s._v(") ")]),s._v("{\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" fns = clientList[key];\n    "),t("span",{staticClass:"hljs-comment"},[s._v("//如果不存在此订阅，直接返回")]),s._v("\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fns) {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),t("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n    }\n    "),t("span",{staticClass:"hljs-comment"},[s._v("//如果没有传入第二个参数，则默认取消所有订阅")]),s._v("\n    "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (!fn) {\n      fns.length = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(";\n    } "),t("span",{staticClass:"hljs-keyword"},[s._v("else")]),s._v(" {\n      "),t("span",{staticClass:"hljs-keyword"},[s._v("for")]),s._v(" ("),t("span",{staticClass:"hljs-keyword"},[s._v("var")]),s._v(" i = "),t("span",{staticClass:"hljs-number"},[s._v("0")]),s._v("; i < fns.length; i++) {\n        "),t("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (fn === fns[i]) {\n          fns.splice(i, "),t("span",{staticClass:"hljs-number"},[s._v("1")]),s._v(");\n        }\n      }\n    }\n\t}\n\t\n  "),t("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" {\n    "),t("span",{staticClass:"hljs-attr"},[s._v("listen")]),s._v(": listen,\n    "),t("span",{staticClass:"hljs-attr"},[s._v("trigger")]),s._v(": trigger,\n    "),t("span",{staticClass:"hljs-attr"},[s._v("remove")]),s._v(": remove\n  }\n})()\n")])])]),t("h2",{attrs:{id:"小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),t("p",[s._v("发布-订阅模式在实际开发中非常有用，它可以实现时间上的解耦和对象上的解耦。现代的MVC和MVVM架构都少不了发布-订阅模式的参与。")]),s._v(" "),t("h2",{attrs:{id:"心得体会"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#心得体会"}},[s._v("#")]),s._v(" 心得体会")]),s._v(" "),t("p",[s._v("发布-订阅模式真的非常强大，在开发中帮助我解决了很多问题。现代很多库和框架的设计思想上都可以看到发布-订阅模式的身影。")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),t("p",[s._v("发布-订阅模式和观察者模式不是同一个东西")])])])}),[],!1,null,null,null);a.default=l.exports}}]);